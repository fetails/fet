<!DOCTYPE html>
<html>
    <head>
        <link href="https://fonts.googleapis.com/css?family=Lato&display=swap" rel="stylesheet">
        <script src="js/jquery.min.js"></script>
        <script src="js/dat.gui.min.js"></script>
        <script src="js/stats.min.js"></script>
        <title>WebGL &bull; Achi</title>
    </head>
    <body>
        <style>
            body, html {
                background-color: #161616;
                font-family: 'Lato', sans-serif;
                margin:0;
                padding:0;
            }
            canvas {
                display:block;
                width:100%;
                height:100vh;
            }
        </style>
        <canvas id="webglex" width="1920" height="1080"></canvas>
        <script src="js/gl-matrix.js"></script>
        <script src="js/achi.js"></script>
        <script type="text/javascript">

        var stats = new Stats();
        stats.showPanel( 0 ); // 0: fps, 1: ms, 2: mb, 3+: custom
        document.body.appendChild( stats.dom );
        
        // ====== Setup canvas gl. ====== //
        let canvas = document.querySelector("#webglex");
        let ogl = canvas.getContext("webgl2");
        if(!ogl)
        {
            alert("Your browser does not support WebGL 2");
        }

        let vdata = 
        "#version 300 es\n\n" +
        
        "in vec3 coords;\n" +
        "out vec3 sent_coords;\n\n" +
        
        "uniform mat4 view_matrix;\n" +
        "uniform mat4 proj_matrix;\n" +
        "uniform mat4 world_matrix;\n\n" +

        "void main() {\n" + 
        " gl_Position = proj_matrix * view_matrix * world_matrix * vec4(coords, 1.0);\n" +
        " sent_coords = coords;\n" +
        "}";

        let fdata =
        "#version 300 es\n\n" +
        "precision mediump float;\n\n" +

        "out vec4 color;\n" +
        "in vec3 sent_coords;\n" +
        "void main() {\n" +
        " color = vec4(sent_coords.x + 0.25, sent_coords.y + 0.25, 0.50, 1);\n" +
        "}";

        let cfg = new AchiConfig();
        let shader = new AchiShader(vdata, fdata);
        let render = new Achi(ogl);

        // Render's the GUI (Dat GUI)
        render.gui();

        // Clear's the screen.
        render.clear();

        // Add's a new buffer to the VBO.
        render.add(new AchiVertex([
        -1.0, 1.0, -1.0,   
		-1.0, 1.0, 1.0,    
		1.0, 1.0, 1.0,     
		1.0, 1.0, -1.0,    

		// Left
		-1.0, 1.0, 1.0,    
		-1.0, -1.0, 1.0,   
		-1.0, -1.0, -1.0,  
		-1.0, 1.0, -1.0,   

		// Right
		1.0, 1.0, 1.0,    
		1.0, -1.0, 1.0,   
		1.0, -1.0, -1.0,  
		1.0, 1.0, -1.0,   

		// Front
		1.0, 1.0, 1.0,    
		1.0, -1.0, 1.0,   
		-1.0, -1.0, 1.0,   
		-1.0, 1.0, 1.0,    

		// Back
		1.0, 1.0, -1.0,    
		1.0, -1.0, -1.0,   
		-1.0, -1.0, -1.0,  
		-1.0, 1.0, -1.0,   

		// Bottom
		-1.0, -1.0, -1.0,  
		-1.0, -1.0, 1.0,   
		1.0, -1.0, 1.0,    
		1.0, -1.0, -1.0
        ], [
        0, 1, 2,
		0, 2, 3,

		// Left
		5, 4, 6,
		6, 4, 7,

		// Right
		8, 9, 10,
		8, 10, 11,

		// Front
		13, 12, 14,
		15, 14, 12,

		// Back
		16, 17, 18,
		16, 18, 19,

		// Bottom
		21, 20, 22,
		22, 20, 23
        ]));

        let m_world_matrix = new Float32Array(16);
        let m_view_matrix = new Float32Array(16);
        let m_projection_matrix = new Float32Array(16);

        glMatrix.mat4.identity(m_world_matrix);
        glMatrix.mat4.lookAt(m_view_matrix, [0, 0, -15], [0, 0, 0], [0, 1, 0]);
        glMatrix.mat4.perspective(m_projection_matrix, glMatrix.glMatrix.toRadian(40), canvas.width / canvas.height, 0.1, 1000.0);
        
        let identity_matrix = new Float32Array(16);
        glMatrix.mat4.identity(identity_matrix);

        let angle = 0;

        render.begin();
        shader.bind();
        shader.uniform_matrix4f("view_matrix", m_view_matrix);
        shader.uniform_matrix4f("world_matrix", m_world_matrix);
        shader.uniform_matrix4f("proj_matrix", m_projection_matrix);
        let loop = function(time)
        {
            angle = performance.now() / 1000 / 2 * 2 * Math.PI;
            render.clear();
            
            
            glMatrix.mat4.rotate(m_world_matrix, identity_matrix, angle, [-1, -1, 0]);
            shader.uniform_matrix4f("world_matrix", m_world_matrix);
            render.render();
            
            requestAnimationFrame( loop );
        };

        loop( 0 );

        </script>
    </body>
</html>