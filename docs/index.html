<!DOCTYPE html>
<html>
    <head>
        <title>Achi</title>
    </head>
    <body>
        <canvas id="mycanvas" width="1920" height="1080"></canvas>
        <style type="text/css">
            body {
                margin:0;
                padding:0;
            }
            canvas {
                width:100vw;
                height:100vh;
                display:block;
            }
        </style>
        <script src="vendor/datgui/dat.gui.min.js"></script>
        <script type="text/javascript">
            let config = function()
            {
                this.version = "v0.2 - unstable";
                this.clear_color = [20, 20, 20, 1.0];
                this.modifier = 0.00;
                this.draw_lines = false;
            };
            class AchiShader
            {
                /**
                * @param {Array} vertex - Vertex String Array
                * @param {Array} fragment - Fragment String Array
                * @param {Achi} achi - Achi Context
                */
                constructor(achi, vertex, fragment)
                {
                    this.gl = achi.gl;

                    let vsCode = vertex.join("\n");
                    let fsCode = fragment.join("\n");

                    console.log("Vertex: ", vsCode);
                    console.log("Fragment: ", fsCode);

                    let vs = this.gl.createShader(this.gl.VERTEX_SHADER);
                    this.gl.shaderSource(vs, vsCode);
                    this.gl.compileShader(vs);

                    let fs = this.gl.createShader(this.gl.FRAGMENT_SHADER);
                    this.gl.shaderSource(fs, fsCode);
                    this.gl.compileShader(fs);

                    let prog = this.gl.createProgram();
                    this.gl.attachShader(prog, vs);
                    this.gl.attachShader(prog, fs);
                    
                    this.gl.linkProgram(prog);
                    this.gl.validateProgram(prog);
                    
                    this.gl.deleteShader(vs);
                    this.gl.deleteShader(fs);

                    this.program = prog;

                }
                /**
                * Bind's the shader
                */
                begin()
                {
                    this.gl.useProgram(this.program);
                }
                /**
                * Unbind's the shader
                */
                end()
                {
                    this.gl.useProgram(null);
                }

                send_float(name, val)
                {
                    let sender = val;
                    this.gl.uniform1f(this.gl.getUniformLocation(this.program, name), sender);
                }
            }
            class Achi
            {
                /**
                * @param {string} canvasId - Canvas ID
                */
                constructor(canvasId)
                {
                    this.canvas = document.querySelector(canvasId);
                    this.gl = this.canvas.getContext("webgl2");
                    if(!this.gl)
                    {
                        alert("[Achi] Error! Your browser does not support WebGL2. :(");
                        return;
                    };
                   
                   // === Dat GUI === //
                    this.config = new config();
                    let gui = new dat.GUI();
                    
                    gui.add(this.config, "version");
                    gui.addColor(this.config, "clear_color");
                    gui.add(this.config, "draw_lines");
                }
                /**
                * Clear's the screen.
                */
                clear()
                {
                    this.gl.clearColor(this.config.clear_color[0] / 255, this.config.clear_color[1] / 255, this.config.clear_color[2] / 255, this.config.clear_color[3]);
                    this.gl.clear(this.gl.COLOR_BUFFER_BIT | this.gl.DEPTH_BUFFER_BIT);
                    this.gl.enable(this.gl.DEPTH_TEST);
                    this.gl.viewport(0, 0, this.canvas.width, this.canvas.height);
                }
                /**
                * Begin's the render sequence
                */
                begin()
                {
                    this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.vbo);
                    this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER, this.ibo);
                    this.gl.vertexAttribPointer(0, 3, this.gl.FLOAT, this.gl.FALSE, 0, 0);
                    this.gl.enableVertexAttribArray(0);
                }
                /**
                * End's the render sequence
                */
                end()
                {
                    this.gl.disableVertexAttribArray(0);
                    this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER, null);
                    this.gl.bindBuffer(this.gl.ARRAY_BUFFER, null);
                }
                /**
                * Create's the VBO & IBO to store data which we will later use to draw our elements.
                */
                create()
                {
                    this.buffer = [
                        0.0, 0.0, 0.0,
                        -0.5, -0.5, 0.0,
                        0.5, -0.5, 0.0
                    ];

                    this.indices = [
                        0, 1, 2,
                        1, 2, 3
                    ];

                    this.vbo = this.gl.createBuffer();
                    this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.vbo);
                    this.gl.bufferData(this.gl.ARRAY_BUFFER, new Float32Array(this.buffer), this.gl.STATIC_DRAW);
                    this.gl.bindBuffer(this.gl.ARRAY_BUFFER, null);

                    this.ibo = this.gl.createBuffer();
                    this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER, this.ibo);
                    this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(this.indices), this.gl.STATIC_DRAW);
                    this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER, null);
                }
                /**
                * Render's our elements.
                */
                render()
                {
                    this.gl.drawElements(this.config.draw_lines == true ? this.gl.LINE_LOOP : this.gl.TRIANGLES, this.indices.length, this.gl.UNSIGNED_SHORT, 0);
                    //this.gl.drawArrays(this.gl.TRIANGLES, 0, 3);
                }
            }
            let achi = new Achi("#mycanvas");
            achi.create();

            let shader = new AchiShader(achi, [
                            "#version 300 es", // Vertex Shader
                            "",
                            "",
                            "in vec3 coordinates;",
                            "out vec3 send_coords;",
                            "",
                            "",
                            "void main() {",
                            " gl_Position = vec4(coordinates, 1.0);",
                            " send_coords = vec3(coordinates.x + 0.45, coordinates.y + 0.45, coordinates.z + 0.25);",
                            "}"
                        ], [
                            "#version 300 es", // Fragment Shader
                            "",
                            "precision mediump float;",
                            "precision mediump int;",
                            "",
                            "out vec4 color;",
                            "in vec3 send_coords;",
                            "",
                            "",
                            "void main() {",
                            " color = vec4(send_coords.x, send_coords.y, send_coords.z, 1);",
                            "}"
                        ]);

            let loop = function()
            {
                achi.clear();
                achi.begin();
                shader.begin();
                achi.render();
                shader.end();
                achi.end();

                requestAnimationFrame(loop);
            };
            loop();
        </script>
    </body>
</html>